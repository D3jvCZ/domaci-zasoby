<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dom√°c√≠ z√°soby - skener + sd√≠len√≠</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--text:#eef2ff;--muted:#9fb0ff;--shadow:0 10px 30px rgba(0,0,0,.25)}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#0b1020;color:var(--text)}
    header{position:sticky;top:0;background:#0b1020cc;border-bottom:1px solid #ffffff22;backdrop-filter:blur(8px);z-index:5}
    .container{max-width:1100px;margin:0 auto;padding:12px}
    h1{margin:6px 0;font-size:20px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#1b2755;border:1px solid #8aa0ff33;box-shadow:0 10px 30px rgba(0,0,0,.25);cursor:pointer}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:#121a33;border:1px solid #8aa0ff2a;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .content{padding:16px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#8aa0ff1f;border:1px solid #8aa0ff3a;font-size:12px}
    .video-wrap{border:1px solid #8aa0ff33;border-radius:14px;overflow:hidden;background:#000}
    video{width:100%;height:auto;display:block}
    .table-wrap{overflow:auto;border:1px solid #8aa0ff2a;border-radius:14px}
    table{width:100%;min-width:760px;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #ffffff12;text-align:left}
    input,select,button{background:#0f1731;color:#eef2ff;border:1px solid #8aa0ff3a;border-radius:10px;padding:9px 10px}
    button{cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{opacity:.8;font-size:12px}
    tr.low td{background:linear-gradient(90deg,rgba(255,176,32,.12),transparent 55%)}
    tr.zero td{background:linear-gradient(90deg,rgba(255,93,93,.12),transparent 55%)}
    dialog{border:1px solid #8aa0ff3a;border-radius:16px;background:#0e1430;color:#eef2ff}
    .danger{color:#ffb4b4}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div>
        <h1>Dom√°c√≠ z√°soby</h1>
        <div class="small">Skenujte ƒç√°rov√©/QR k√≥dy, evidujte polo≈æky a sd√≠lejte.</div>
      </div>
      <div class="toolbar">
        <button id="btnStartScan" class="pill">üì∑ Spustit skenov√°n√≠</button>
        <button id="btnStopScan" class="pill">‚èπÔ∏è Zastavit</button>
        <button id="btnAddManual" class="pill">‚ûï P≈ôidat ruƒçnƒõ</button>
        <button id="btnExport" class="pill">‚¨áÔ∏è Export</button>
        <label class="pill" for="fileImport" style="cursor:pointer">‚¨ÜÔ∏è Import</label>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
        <button id="btnShare" class="pill">üë• Sd√≠len√≠</button>
      </div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <div class="content">
        <h2>Skener</h2>
        <div class="row" style="justify-content:space-between">
          <div id="scanStatus" class="badge">Neaktivn√≠</div>
          <div class="small">Tip: Spus≈• p≈ôes HTTPS (GitHub Pages) a povol kameru.</div>
        </div>
        <div class="video-wrap" style="margin-top:10px"><video id="video" playsinline muted></video></div>
        <div id="scanError" class="small danger" style="min-height:1em;margin-top:8px"></div>
      </div>
    </section>

    <section class="card">
      <div class="content">
        <h2>Filtr & Souhrn</h2>
        <div class="row">
          <input id="search" placeholder="Hledat podle n√°zvu nebo k√≥du‚Ä¶" />
          <select id="filter"><option value="all">V≈°e</option><option value="low">Doch√°z√≠</option><option value="zero">0 ks</option></select>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="badge" id="badgeTotal">Celkem polo≈æek: 0</div>
          <div class="badge" id="badgeLow">Doch√°z√≠: 0</div>
          <div class="badge" id="badgeZero">Na nule: 0</div>
          <div class="badge" id="badgeUpdated">Naposledy: ‚Äì</div>
        </div>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="content">
        <h2>Invent√°≈ô</h2>
        <div class="table-wrap">
          <table id="table"><thead><tr>
            <th>N√°zev</th><th>K√≥d</th><th>Mno≈æstv√≠</th><th>Minimum</th><th>Pozn√°mka</th><th>Upravit</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>
  </main>

  <footer class="container small" style="opacity:.8;padding:10px 0 22px">
    Data se ukl√°daj√≠ lok√°lnƒõ (localStorage). Pro sd√≠len√≠ pou≈æij ‚ÄûSd√≠len√≠ ‚Üí Bez √∫ƒçtu (Pantry ID)‚Äú.
  </footer>

  <!-- ZXing fallback (kdy≈æ nen√≠ BarcodeDetector) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script>
    const $ = s => document.querySelector(s);

    // ===== Stav a √∫lo≈æi≈°tƒõ =====
    const LS_KEY = 'pantry_inventory_v1';
    const state = {
      items: loadItems(),
      scanning: false,
      lastUpdated: loadLastUpdated(),
      remote: { enabled:false, cfg: loadRemoteCfg(), applying:false, pollTimer:null }
    };
    function loadItems(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] }catch{ return [] } }
    function loadLastUpdated(){ return localStorage.getItem(LS_KEY+':updated')||null }
    function saveItems(){
      localStorage.setItem(LS_KEY, JSON.stringify(state.items));
      state.lastUpdated = new Date().toISOString();
      localStorage.setItem(LS_KEY+':updated', state.lastUpdated);
      renderBadges();
      pushRemote();
    }

    // ===== Pomocn√© =====
    const units=['ks','g','kg','ml','l','balen√≠'];
    const fmtDate = iso=> iso? new Date(iso).toLocaleString(): '‚Äì';
    const findByCode = code => state.items.find(i=>i.code===code);
    const upsertItem = item => { const i=state.items.findIndex(x=>x.code===item.code); if(i>-1) state.items[i]=item; else state.items.unshift(item); saveItems(); renderTable(); };
    const escapeHtml = s=> String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c]));

    // ===== UI: p≈ôehled =====
    function renderBadges(){
      $('#badgeTotal').textContent = `Celkem polo≈æek: ${state.items.length}`;
      const low = state.items.filter(i=>i.quantity<=i.min && i.quantity>0).length;
      const zero = state.items.filter(i=>i.quantity<=0).length;
      $('#badgeLow').textContent = `Doch√°z√≠: ${low}`;
      $('#badgeZero').textContent = `Na nule: ${zero}`;
      $('#badgeUpdated').textContent = `Naposledy: ${fmtDate(state.lastUpdated)}`;
    }

    function renderTable(){
      const q=$('#search').value.trim().toLowerCase();
      const f=$('#filter').value;
      const tbody=$('#table tbody'); tbody.innerHTML='';
      state.items
        .filter(i=>!q || i.name.toLowerCase().includes(q) || (i.code||'').includes(q))
        .filter(i=> f==='all' || (f==='low' && i.quantity<=i.min && i.quantity>0) || (f==='zero' && i.quantity<=0))
        .forEach(i=>{
          const tr=document.createElement('tr');
          if(i.quantity<=0) tr.classList.add('zero'); else if(i.quantity<=i.min) tr.classList.add('low');
          tr.innerHTML = `
            <td>${escapeHtml(i.name)}</td>
            <td class="small">${i.code||'‚Äî'}</td>
            <td><div class="row" style="gap:6px;align-items:center">
              <button onclick="changeQty('${i.code}',-1)">‚àí</button>
              <strong>${Number(i.quantity)}</strong> <span class="small">${i.unit}</span>
              <button onclick="changeQty('${i.code}',+1)">+</button>
            </div></td>
            <td>${i.min} <span class="small">${i.unit}</span></td>
            <td class="small">${escapeHtml(i.note||'')}</td>
            <td><button onclick="editItem('${i.code}')">‚úèÔ∏è</button> <button onclick="removeItem('${i.code}')">üóëÔ∏è</button></td>`;
          tbody.appendChild(tr);
        });
      renderBadges();
    }

    // Qty / edit / delete
    window.changeQty=(code,delta)=>{ const it=findByCode(code); if(!it) return; it.quantity=Math.max(0,Number(it.quantity||0)+delta); it.updatedAt=new Date().toISOString(); saveItems(); renderTable(); };
    window.editItem=(code)=>{ const it=findByCode(code); if(!it) return; openItemDialog({...it}); };
    window.removeItem=(code)=>{ const idx=state.items.findIndex(i=>i.code===code); if(idx>-1 && confirm('Opravdu smazat polo≈æku?')){ state.items.splice(idx,1); saveItems(); renderTable(); } };

    // ===== Dialog pro p≈ôid√°n√≠/√∫pravu polo≈æky =====
    const dlg=document.createElement('dialog');
    dlg.innerHTML=`<form method="dialog" class="content">
      <h2 id="dlgTitle">P≈ôidat polo≈æku</h2>
      <div class="row">
        <label style="flex:1">N√°zev<br><input id="fName" required placeholder="Nap≈ô. ≈†pagety"/></label>
        <label style="flex:1">K√≥d (EAN/QR)<br><input id="fCode" placeholder="Naskenujte nebo zadejte"/></label>
      </div>
      <div class="row">
        <label>Mno≈æstv√≠<br><input id="fQty" type="number" min="0" step="1" value="1"/></label>
        <label>Jednotka<br><select id="fUnit"></select></label>
        <label>Minimum<br><input id="fMin" type="number" min="0" step="1" value="1"/></label>
      </div>
      <label>Pozn√°mka<br><input id="fNote" placeholder="Znaƒçka, p≈ô√≠chu≈•‚Ä¶"/></label>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button value="cancel">Zru≈°it</button>
        <button id="dlgSubmit" class="pill" value="default">Ulo≈æit</button>
      </div>
    </form>`;
    document.body.appendChild(dlg);

    function openItemDialog(item){
      const isEdit = !!item && !!item.code && !!findByCode(item.code);
      dlg.querySelector('#dlgTitle').textContent = isEdit? 'Upravit polo≈æku':'P≈ôidat polo≈æku';
      const unitSel = dlg.querySelector('#fUnit'); unitSel.innerHTML = units.map(u=>`<option value="${u}">${u}</option>`).join('');
      dlg.querySelector('#fName').value = item?.name||'';
      dlg.querySelector('#fCode').value = item?.code||'';
      dlg.querySelector('#fQty').value = item?.quantity??1;
      dlg.querySelector('#fUnit').value = item?.unit||'ks';
      dlg.querySelector('#fMin').value = item?.min??1;
      dlg.querySelector('#fNote').value = item?.note||'';
      dlg.showModal();
      dlg.querySelector('#dlgSubmit').onclick = (e)=>{
        e.preventDefault();
        const newItem={
          name: dlg.querySelector('#fName').value.trim()||'Polo≈æka',
          code: dlg.querySelector('#fCode').value.trim()||'',
          quantity: Number(dlg.querySelector('#fQty').value)||0,
          unit: dlg.querySelector('#fUnit').value,
          min: Number(dlg.querySelector('#fMin').value)||0,
          note: dlg.querySelector('#fNote').value.trim(),
          updatedAt: new Date().toISOString(),
        };
        if(!newItem.code && !confirm('Polo≈æka nem√° k√≥d. P≈ôesto ulo≈æit?')) return;
        upsertItem(newItem); dlg.close();
      }
    }

    // ===== Export / Import =====
    $('#btnExport').addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify({items:state.items,updatedAt:state.lastUpdated},null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`zasoby-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    $('#fileImport').addEventListener('change',e=>{
      const file=e.target.files?.[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(Array.isArray(d)) state.items=d; else if(d&&Array.isArray(d.items)) state.items=d.items; else throw new Error('≈†patn√Ω form√°t'); saveItems(); renderTable(); alert('Import hotov ‚úÖ'); }catch(err){ alert('Neplatn√Ω soubor: '+err.message) } }; r.readAsText(file); e.target.value='';
    });

    $('#search').addEventListener('input',renderTable);
    $('#filter').addEventListener('change',renderTable);
    $('#btnAddManual').addEventListener('click',()=>openItemDialog({quantity:1,min:1,unit:'ks'}));

    // ===== SKENOV√ÅN√ç =====
    const statusEl = $('#scanStatus');
    const errEl = $('#scanError');
    const video = $('#video');
    const scan = { stream:null, detector:null, raf:0, zxing:null, zxingActive:false };

    function setError(msg){ errEl.textContent = msg || ''; }
    function setStatus(text){ statusEl.textContent = text; }

    async function startScan(){
      setError('');
      try{
        // Kamera (zadn√≠, pokud je)
        scan.stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
        video.srcObject = scan.stream; await video.play();
        setStatus('Bƒõ≈æ√≠');

        // Preferuj BarcodeDetector
        if('BarcodeDetector' in window){
          try{
            const formats=['ean_13','ean_8','upc_a','upc_e','code_128','qr_code'];
            scan.detector = new BarcodeDetector({ formats });
            loopDetector();
            return;
          }catch(e){ console.warn('BarcodeDetector init fail', e); }
        }
        // Fallback: ZXing - decodeFromVideoDevice
        try{
          scan.zxing = new ZXing.BrowserMultiFormatReader();
          scan.zxingActive = true;
          await scan.zxing.decodeFromVideoDevice(null, 'video', (result, err)=>{
            if(result){ handleCode(result.getText()); }
          });
        }catch(e){
          setError('ZXing fallback selhal: ' + e.message);
        }
      }catch(e){
        setError('Nelze spustit kameru: ' + (e.message || e.name));
        setStatus('Neaktivn√≠');
      }
    }

    function stopScan(){
      cancelAnimationFrame(scan.raf);
      if (scan.zxing && scan.zxingActive){ try{ scan.zxing.reset(); }catch{} scan.zxingActive=false; }
      if (scan.stream){ scan.stream.getTracks().forEach(t=>t.stop()); }
      video.srcObject = null; scan.stream = null; scan.detector = null;
      setStatus('Neaktivn√≠');
    }

    async function loopDetector(){
      if(!scan.detector) return;
      try{
        const codes = await scan.detector.detect(video);
        if (codes && codes.length){ handleCode(codes[0].rawValue || ''); await new Promise(r=>setTimeout(r,600)); }
      }catch(e){ /* frame bez k√≥du */ }
      scan.raf = requestAnimationFrame(loopDetector);
    }

    function handleCode(code){
      if(!code) return;
      // buƒè p≈ôidat k existuj√≠c√≠ polo≈æce, nebo otev≈ô√≠t dialog s p≈ôedvyplnƒõn√Ωm k√≥dem
      const ex = findByCode(code);
      if(ex){
        if(confirm(`Nalezeno: ${ex.name}\n\nP≈ôidat 1 ${ex.unit}? (OK = p≈ôidat, Zru≈°it = upravit)`)){ changeQty(code, +1); }
        else { openItemDialog(ex); }
      } else {
        openItemDialog({ code, quantity:1, min:1, unit:'ks' });
      }
      // po naƒçten√≠ k√≥du sken zastav√≠me (a≈• to nesk√°ƒçe d√°l); m≈Ø≈æe≈° klidnƒõ zavolat startScan znovu
      stopScan();
    }

    $('#btnStartScan').addEventListener('click', startScan);
    $('#btnStopScan').addEventListener('click', stopScan);

    // Drobn√° diagnostika prost≈ôed√≠
    window.addEventListener('load', ()=>{
      if(!('mediaDevices' in navigator)) setError('Tento prohl√≠≈æeƒç nepodporuje kameru. Zkus jin√© za≈ô√≠zen√≠/prohl√≠≈æeƒç.');
      if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
        setError('Spus≈• pros√≠m p≈ôes HTTPS (GitHub Pages). Bez HTTPS nemus√≠ j√≠t kamera.');
      }
    });

    // ===== SD√çLEN√ç ‚Äì Bez √∫ƒçtu (Pantry ID) =====
    const shareDlg=document.createElement('dialog');
    shareDlg.innerHTML=`<form method="dialog" class="content">
      <h2>Sd√≠len√≠ ‚Äì Bez √∫ƒçtu (Pantry ID)</h2>
      <div class="small" style="margin-bottom:8px">1) Otev≈ôi <a href="https://getpantry.cloud/" target="_blank">getpantry.cloud</a> ‚Üí Create Pantry ‚Üí zkop√≠ruj <code>Pantry ID</code>.<br>2) Vlo≈æ ho sem. Stejn√Ω k√≥d pou≈æije i druh√© za≈ô√≠zen√≠.</div>
      <label>Pantry ID<br><input id="pantryId" placeholder="nap≈ô. 3d4c..."/></label>
      <div class="row" style="justify-content:flex-end;margin-top:12px"><button value="cancel">Zru≈°it</button><button id="btnConnectPantry" class="pill" value="default">Ulo≈æit & p≈ôipojit</button></div>
    </form>`;
    document.body.appendChild(shareDlg);

    function loadRemoteCfg(){ try{ return JSON.parse(localStorage.getItem('pantry_sync_cfg'))||{} }catch{ return {} } }
    function saveRemoteCfg(cfg){ localStorage.setItem('pantry_sync_cfg', JSON.stringify(cfg||{})); }

    $('#btnShare').addEventListener('click',()=>{ shareDlg.querySelector('#pantryId').value = state.remote.cfg.pantryId||''; shareDlg.showModal(); });
    shareDlg.querySelector('#btnConnectPantry').addEventListener('click',async (e)=>{
      e.preventDefault();
      const id=shareDlg.querySelector('#pantryId').value.trim();
      state.remote.cfg={ pantryId:id }; saveRemoteCfg(state.remote.cfg);
      shareDlg.close(); await connectPantry();
      if(state.remote.enabled) alert('Sd√≠len√≠ p≈ôipojeno ‚úÖ');
    });

    async function connectPantry(){
      const id = state.remote.cfg?.pantryId; if(!id) return; state.remote.enabled=true;
      try{
        const res = await fetch(`https://api.getpantry.cloud/apiv1/pantry/${id}/basket/home-stock`);
        if(res.ok){
          const data=await res.json();
          if(data && Array.isArray(data.items)){
            if(!state.lastUpdated || (data.updatedAt && data.updatedAt>state.lastUpdated)){
              state.remote.applying=true;
              state.items=data.items; localStorage.setItem(LS_KEY, JSON.stringify(state.items));
              state.lastUpdated=data.updatedAt; localStorage.setItem(LS_KEY+':updated', state.lastUpdated);
              renderTable(); state.remote.applying=false;
            }
          }
        }
      }catch{}
      // poll ka≈æd√Ωch 5 s
      if(state.remote.pollTimer) clearInterval(state.remote.pollTimer);
      state.remote.pollTimer=setInterval(async()=>{
        try{
          const r=await fetch(`https://api.getpantry.cloud/apiv1/pantry/${id}/basket/home-stock`);
          if(!r.ok) return;
          const d=await r.json();
          if(d && d.updatedAt && (!state.lastUpdated || d.updatedAt>state.lastUpdated)){
            state.remote.applying=true;
            state.items=Array.isArray(d.items)?d.items:[];
            localStorage.setItem(LS_KEY, JSON.stringify(state.items));
            state.lastUpdated=d.updatedAt; localStorage.setItem(LS_KEY+':updated', state.lastUpdated);
            renderTable(); state.remote.applying=false;
          }
        }catch{}
      }, 5000);
    }

    async function pushRemote(){
      if(state.remote.applying) return;
      const id=state.remote.cfg?.pantryId; if(!id) return;
      try{
        const payload={items:state.items,updatedAt:state.lastUpdated};
        await fetch(`https://api.getpantry.cloud/apiv1/pantry/${id}/basket/home-stock`, {
          method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
      }catch{}
    }

    // ===== Inicializace =====
    renderTable();
    if(state.remote.cfg?.pantryId) connectPantry();
  </script>
</body>
</html>
